<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Listen to the tests, they tell smells in your code...</title>
  <!-- <meta name="description" content="<p>Recently, reading <a href="http://www.amazon.com/Growing-Object-Oriented-Software-Guided-Tests/dp/0321503627">Growing Object Oriented Software Guided Tests</a>, written by <a href="http://www.m3p.co.uk/blog">Steve Freeman</a> and <a href="http://www.natpryce.com">Nat Pryce</a>, it reminded me of a project I worked on a while ago. It was a one year old system, poorly tested, integrating to a handful of other systems, and the code-base... well I prefer not to remember. Despite this scenario, I joined the team to help them implement some new functionalities.</p>
" /> -->

  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@amartinsn" />
    <meta name="twitter:title" content="Listen to the tests, they tell smells in your code..." />
    <meta name="twitter:image" content="http://alexmartins.me/assets/images/author.jpg" />
    
    <meta name="twitter:description"  content="Recently, reading Growing Object Oriented Software Guided Tests, written by Steve Freeman and Nat Pryce, it reminded me of a project I worked on a while ago. It was a one year old system, poorly te..." />
    
  

  <meta property="og:site_name" content="Alexandre Martins" />
  <meta property="og:title" content="Listen to the tests, they tell smells in your code..."/>
  
  <meta property="og:description" content="Recently, reading Growing Object Oriented Software Guided Tests, written by Steve Freeman and Nat Pryce, it reminded me of a project I worked on a while ago. It was a one year old system, poorly te..." />
  
  <meta property="og:image" content="http://alexmartins.me/assets/images/author.jpg" />
  <meta property="og:url" content="http://alexmartins.me/2010/07/26/listen-to-the-tests-they-tell-smells-in-your-code.html" >
  <meta property="og:type" content="blog" />
  <meta property="article:published_time" content="2010-07-26T00:00:00-03:00">

  <link rel="canonical" href="http://alexmartins.me/2010/07/26/listen-to-the-tests-they-tell-smells-in-your-code.html">

  <link rel="shortcut icon" href="/assets/images/favicon.ico">
  <link rel="stylesheet" href="//brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
  <link rel="stylesheet" type="text/css" media="print" href="/css/print.css" />
</head>

  <body itemscope itemtype="http://schema.org/Article">
    <!-- header start -->

<!-- <a href="http://alexmartins.me" class="logo-readium"><span class="logo" style="background-image: url(/assets/images/author.jpg)"></span></a> -->

<!-- header end -->

    <main class="content" role="main">
      <article class="post">
        
        <div class="noarticleimage">
          <div class="post-meta">
            <h1 class="post-title">Listen to the tests, they tell smells in your code...</h1>
            <div class="cf post-meta-text">
              <div class="author-image" style="background-image: url(/assets/images/author.jpg)">Blog Logo</div>
              <a class="author-name" href="http://alexmartins.me" itemprop="author" itemscope itemtype="http://schema.org/Person">Alexandre Martins</a>
              on
              <time datetime="2010-07-26T00:00:00-03:00">26 Jul 2010</time>
              <!-- , tagged on <span class="post-tag-">, <a href="/tag/"></a></span> -->
            </div>
          </div>
        </div>
        <br>
        <br>
        
        <section class="post-content">
          <div class="post-reading">
            <span class="post-reading-time"></span> read
          </div>
          <a name="topofpage"></a>
          <p>Recently, reading <a href="http://www.amazon.com/Growing-Object-Oriented-Software-Guided-Tests/dp/0321503627">Growing Object Oriented Software Guided Tests</a>, written by <a href="http://www.m3p.co.uk/blog">Steve Freeman</a> and <a href="http://www.natpryce.com">Nat Pryce</a>, it reminded me of a project I worked on a while ago. It was a one year old system, poorly tested, integrating to a handful of other systems, and the code-base... well I prefer not to remember. Despite this scenario, I joined the team to help them implement some new functionalities.</p>

<p>I remember sometimes it was difficult to write tests, the classes were tightly coupled, with no clear responsibilities, several attributes, bloated constructors, etc. And despite our best effort, working around the bits that were preventing us from writing the tests, we felt we were getting down the wrong road, trying to do it in such a crappy code-base. As a result some of our tests were massive! A bunch of lines of mocks, stubs, and expectations, making it impossible to understand their purpose.</p>

<h3>What have I learned?</h3>

<p>Reading one of the book chapters I learned that the same qualities that makes an object easy to test also makes the code responsive to change. In my situation, the tests were telling me how clumsy the code was and how difficult it would be to extend it.</p>

<p>I also learned that when we come across a functionality that is difficult to test, asking ourselves how to test it is not enough, we also have to ask why is it difficult to test, and check whether it&#39;s an opportunity to improve our code. The trick is to do it driven by tests, so we can get rapid feedback on code&#39;s internal qualities and on whether it&#39;s doing what it&#39;s supposed to do.</p>

<p>So they introduced a variation for the well-known TDD cycle— <em><strong>&quot;Write a failing test&quot; =&gt; &quot;Make the test pass&quot; =&gt; &quot;Refactor&quot;</strong></em>. As described on the figure below (extracted from the book), if we&#39;re finding it hard to write the next failing test for our application, we should look again at the design of the production code and often refactor it before moving on, until we get to the point that we can write tests that reads well.</p>

<p><img src="/assets/article_images/2010-07-26-listen-to-the-tests-they-tell-smells-in-your-code/tdd-cycle.png" alt="Extracted from Growing Object-Oriented Software, Guided By Tests— Steve Freeman and Nat Pryce"></p>

<p>Extracted from Growing Object-Oriented Software, Guided By Tests— Steve Freeman and Nat Pryce</p>

<h3>An Example of a Smell Tests Might Be Telling You</h3>

<h4>Reference data rather than behavior</h4>

<p>When applying <a href="http://pragprog.com/articles/tell-dont-ask">&quot;Tell Don&#39;t Ask&quot;</a> or <a href="http://pragprog.com/articles/tell-dont-ask">&quot;Law of Demeter&quot;</a> consistently, we end up with a coding style where we tend to pass behavior into the system instead of pulling values up through the stack. So picking up the famous Paperboy example, before refactoring the code applying the &quot;Law of Demeter&quot; the code and test would look something along the lines of the snippet showed below.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Paperboy</span>
  <span class="k">def</span> <span class="nf">collect_money</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">due_amount</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">due_amount</span> <span class="o">&gt;</span> <span class="n">customer</span><span class="o">.</span><span class="n">wallet</span><span class="o">.</span><span class="n">cash</span>
      <span class="k">raise</span> <span class="no">InsuficientFundsError</span>
    <span class="k">else</span>
      <span class="n">customer</span><span class="o">.</span><span class="n">wallet</span><span class="o">.</span><span class="n">cash</span> <span class="o">-=</span> <span class="n">due_amount</span>
      <span class="vi">@total_collected</span> <span class="o">+=</span> <span class="n">due_amount</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">it</span> <span class="s2">&quot;should collect money from customer&quot;</span> <span class="k">do</span>
  <span class="n">customer</span> <span class="o">=</span> <span class="no">Customer</span><span class="o">.</span><span class="n">new</span> <span class="ss">:wallet</span> <span class="o">=&gt;</span> <span class="no">Wallet</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:amount</span> <span class="o">=&gt;</span> <span class="mi">200</span><span class="p">)</span>
  <span class="n">paperboy</span> <span class="o">=</span> <span class="no">Paperboy</span><span class="o">.</span><span class="n">new</span>
  <span class="n">paperboy</span><span class="o">.</span><span class="n">total_collected</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="mi">0</span>
  <span class="n">paperboy</span><span class="o">.</span><span class="n">collect_money</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
  <span class="n">customer</span><span class="o">.</span><span class="n">wallet</span><span class="o">.</span><span class="n">cash</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="mi">150</span>
  <span class="n">paperboy</span><span class="o">.</span><span class="n">total_collected</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="mi">50</span>
<span class="k">end</span>
</code></pre></div>
<p>We can easily see that the test is telling us it knows too much detail about Customer class implementation. We can see its internals, which objects it&#39;s related to, and even worse, we&#39;re also exposing implementation details of its peers. So it&#39;s clear for me that it needs some design improvement. My main goal here is to hide Customer implementation details from the users of the Paperboy class. Which means that I don&#39;t wanna see anything but Customer and Moneyclasses referenced on the test!</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Paperboy</span>
  <span class="k">def</span> <span class="nf">collect_money</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="n">due_amount</span><span class="p">)</span>
    <span class="vi">@collected_amount</span> <span class="o">+=</span> <span class="n">customer</span><span class="o">.</span><span class="n">pay</span><span class="p">(</span><span class="n">due_amount</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">it</span> <span class="s2">&quot;should collect money from customer&quot;</span> <span class="k">do</span>
  <span class="n">customer</span> <span class="o">=</span> <span class="no">Customer</span><span class="o">.</span><span class="n">new</span> <span class="ss">:total_cash</span> <span class="o">=&gt;</span> <span class="mi">200</span>
  <span class="n">paperboy</span> <span class="o">=</span> <span class="no">Paperboy</span><span class="o">.</span><span class="n">new</span>
  <span class="n">paperboy</span><span class="o">.</span><span class="n">total_collected</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="mi">0</span>
  <span class="n">paperboy</span><span class="o">.</span><span class="n">collect_money</span><span class="p">(</span><span class="n">customer</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
  <span class="n">customer</span><span class="o">.</span><span class="n">total_cash</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="mi">150</span>
  <span class="n">paperboy</span><span class="o">.</span><span class="n">total_collected</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="mi">50</span>
<span class="k">end</span>
</code></pre></div>
<p>The method <code>customer.pay(due_amount)</code> wraps all the implementation detail up behind a single call. The client of paperboy no longer needs to know anything about the types in the chain. We&#39;ve reduced the risk that a design change might cause ripples in remote parts of the codebase.</p>

<p>As well as hiding information, there&#39;s a more subtle benefit from &quot;Tell, Don&#39;t Ask.&quot; It forces us to make explicit and so name the interactions between objects, rather than leaving them implicit in the chain of getters. The shorter version above is much clearer about <strong>what</strong> it&#39;s for, not just <strong>how</strong> it happens to be implemented.</p>

<p>All the logic necessary to collect the money is inside the <code>Customer</code> object, so it doesn&#39;t have to expose its state to its peers.</p>

<p>Now it&#39;s safer to continue writing new failing tests to our objects. Remember, listen to the tests!</p>

        </section>
        <footer class="post-footer">
          <section class="share">
            
              
                <a class="icon-twitter" href="http://twitter.com/share?text=Listen+to+the+tests%2C+they+tell+smells+in+your+code...&amp;url=http://alexmartins.me/2010/07/26/listen-to-the-tests-they-tell-smells-in-your-code"
                  onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
                <i class="fa fa-twitter"></i><span class="hidden">twitter</span>
                </a>
              
            
              
            
              
            
          </section>
        </footer>
        <div class="bottom-teaser cf">
          <h5 class="index-headline featured"><span>Written by</span></h5>
          <section class="author">
            <div class="author-image" style="background-image: url(/assets/images/author.jpg)">Blog Logo</div>
            <h4>Alexandre Martins</h4>
            <p class="bio">Tech Lead and Agile Coach. Currently helping build the technology vision and architecture of Globo's video streaming platform.</p>
            <p class="published">Published <time datetime="2010-07-26 00:00">26 Jul 2010</time></p>
          </section>
          
        </div>
        
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'alexmartins'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        
      </article>
    </main>
    <div class="bottom-closer">

    </div>
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/assets/js/index.js"></script>
<script type="text/javascript" src="/assets/js/readingTime.min.js"></script>
<script>
(function ($) {
  "use strict";
  $(document).ready(function(){

    var $window = $(window),
    $image = $('.post-image-image, .teaserimage-image');

      $window.on('scroll', function() {
        var top = $window.scrollTop();

        if (top < 0 || top > 1500) { return; }
        $image
          .css('transform', 'translate3d(0px, '+top/3+'px, 0px)')
          .css('opacity', 1-Math.max(top/700, 0));
      });
      $window.trigger('scroll');

      var height = $('.article-image').height();
      $('.post-content').css('padding-top', height + 'px');

      $('a[href*=#]:not([href=#])').click(function() {
        if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'')
         && location.hostname == this.hostname) {
          var target = $(this.hash);
          target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
          if (target.length) {
            $('html,body').animate({ scrollTop: target.offset().top }, 500);
            return false;
          }
        }
      });

  });
}(jQuery));
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-67119919-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>
