<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Building Fault Tolerant Clients With Finagle - Part 1</title>
  <!-- <meta name="description" content="<p>We&#39;ve been using <a href="http://twitter.github.io/finagle">Finagle</a> quite a lot on our current project, so I decided to dig into the <a href="http://twitter.github.io/finagle/guide/Clients.html">Client</a> implementation in order to check if we are properly using it and understand what else it could offer us.</p>
" /> -->

  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@amartinsn" />
    <meta name="twitter:title" content="Building Fault Tolerant Clients With Finagle - Part 1" />
    <meta name="twitter:image" content="http://alexmartins.me/assets/images/author.jpg" />
    
    <meta name="twitter:description"  content="We&#39;ve been using Finagle quite a lot on our current project, so I decided to dig into the Client implementation in order to check if we are properly using it and understand what else it could o..." />
    
  

  <meta property="og:site_name" content="Alexandre Martins" />
  <meta property="og:title" content="Building Fault Tolerant Clients With Finagle - Part 1"/>
  
  <meta property="og:description" content="We&#39;ve been using Finagle quite a lot on our current project, so I decided to dig into the Client implementation in order to check if we are properly using it and understand what else it could o..." />
  
  <meta property="og:image" content="http://alexmartins.me/assets/images/author.jpg" />
  <meta property="og:url" content="http://alexmartins.me/2015/12/30/building-fault-tolerant-clients-with-finagle-part-1.html" >
  <meta property="og:type" content="blog" />
  <meta property="article:published_time" content="2015-12-30T00:00:00-02:00">

  <link rel="canonical" href="http://alexmartins.me/2015/12/30/building-fault-tolerant-clients-with-finagle-part-1.html">

  <link rel="shortcut icon" href="/assets/images/favicon.ico">
  <link rel="stylesheet" href="//brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
  <link rel="stylesheet" type="text/css" media="print" href="/css/print.css" />
</head>

  <body itemscope itemtype="http://schema.org/Article">
    <!-- header start -->

<!-- <a href="http://alexmartins.me" class="logo-readium"><span class="logo" style="background-image: url(/assets/images/author.jpg)"></span></a> -->

<!-- header end -->

    <main class="content" role="main">
      <article class="post">
        
        <div class="noarticleimage">
          <div class="post-meta">
            <h1 class="post-title">Building Fault Tolerant Clients With Finagle - Part 1</h1>
            <div class="cf post-meta-text">
              <div class="author-image" style="background-image: url(/assets/images/author.jpg)">Blog Logo</div>
              <a class="author-name" href="http://alexmartins.me" itemprop="author" itemscope itemtype="http://schema.org/Person">Alexandre Martins</a>
              on
              <time datetime="2015-12-30T00:00:00-02:00">30 Dec 2015</time>
              <!-- , tagged on <span class="post-tag-">, <a href="/tag/"></a></span> -->
            </div>
          </div>
        </div>
        <br>
        <br>
        
        <section class="post-content">
          <div class="post-reading">
            <span class="post-reading-time"></span> read
          </div>
          <a name="topofpage"></a>
          <p>We&#39;ve been using <a href="http://twitter.github.io/finagle">Finagle</a> quite a lot on our current project, so I decided to dig into the <a href="http://twitter.github.io/finagle/guide/Clients.html">Client</a> implementation in order to check if we are properly using it and understand what else it could offer us.</p>

<p>Finagle currently ships with client implementation for protocols such as <strong>HTTP</strong>, <strong>MySql</strong>, <strong>Redis</strong>, <strong>Memcached</strong>, and is <a href="https://twitter.github.io/finagle/guide/Extending.html">extensible</a> for any protocol implementation. Initializing a HTTP client for example, would be as simple as:</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">client</span> <span class="k">=</span> <span class="nc">Http</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">newService</span><span class="o">(</span><span class="s">&quot;example.com:80&quot;</span><span class="o">)</span>
</code></pre></div>
<p>This creates a new client for the host and port specified, and from that it&#39;s fairly simple to send requests out and work with responses as follows:</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">req</span> <span class="k">=</span> <span class="nc">Request</span><span class="o">(</span><span class="s">&quot;/foo&quot;</span><span class="o">,</span> <span class="o">(</span><span class="s">&quot;my-query-string&quot;</span><span class="o">,</span> <span class="s">&quot;bar&quot;</span><span class="o">))</span>
<span class="n">req</span><span class="o">.</span><span class="n">host</span> <span class="k">=</span> <span class="s">&quot;example.com&quot;</span>

<span class="k">val</span> <span class="n">resp</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Response</span><span class="o">]</span> <span class="k">=</span> <span class="n">client</span><span class="o">(</span><span class="n">req</span><span class="o">)</span>
</code></pre></div>
<p>There&#39;s also another handy method for retrieving page content based on a HTTP url, which currently doesn&#39;t support HTTPS.</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">resp</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Response</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Http</span><span class="o">.</span><span class="n">fetchUrl</span><span class="o">(</span><span class="s">&quot;http://example.com&quot;</span><span class="o">)</span>
</code></pre></div>
<p>But as we all know, the only certainty we have when integrating with external services is that it will fail at some point in time. That will happen for lots of different reasons such as network problems, bugs on the service, unavailability, etc.</p>

<p>It&#39;s really important to understand these types of failures and take them into account when defining clients that will act as integration points with external services.</p>

<p>Currently Finagle client implementation comes with support to <strong>Timeouts</strong>, <strong>Retries</strong>, <strong>Circuit Breakers</strong>, <strong>Tracing</strong>, <strong>Rate Limiting</strong>, among other features, and it can also be customized by composing with custom <code>Filter</code> and <code>Service</code> implementations.</p>

<h3>Timeouts</h3>

<p>Nowadays pretty much every application needs to integrate with other services through the network. In case of any problem with the service or the network, timeouts are used to tell the client when it&#39;s time to give up and keep going, instead of waiting for a response that might never come.</p>

<p>The <a href="https://github.com/twitter/finagle/blob/master/finagle-core/src/main/scala/com/twitter/finagle/service/TimeoutFilter.scala">TimeoutFilter</a> are used to configure global timeouts, that will be applied to every request performed by the client.</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">timeoutFilter</span><span class="o">[</span><span class="kt">Req</span>, <span class="kt">Rep</span><span class="o">](</span><span class="n">duration</span><span class="k">:</span> <span class="kt">Duration</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">timer</span> <span class="k">=</span> <span class="nc">DefaultTimer</span><span class="o">.</span><span class="n">twitter</span>
  <span class="k">new</span> <span class="nc">TimeoutFilter</span><span class="o">[</span><span class="kt">Req</span>, <span class="kt">Rep</span><span class="o">](</span><span class="n">duration</span><span class="o">,</span> <span class="n">timer</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div><div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">clientWithTimeout</span> <span class="k">=</span> <span class="n">timeoutFilter</span><span class="o">(</span><span class="mf">1.</span><span class="n">second</span><span class="o">)</span> <span class="n">andThen</span> <span class="n">client</span>
</code></pre></div>
<p>But it&#39;s also possible to specify the timeout criteria on request level, which will take precedence over the global timeout configuration.</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">client</span><span class="o">(</span><span class="n">req</span><span class="o">)</span> <span class="n">within</span> <span class="mf">1.</span><span class="n">second</span>
</code></pre></div>
<h3>Retries</h3>

<p>When a call to a service results on failure, timeout or is successful but returned an undesired result, there&#39;s the chance of retrying the request on a hope for a successful and desired result.</p>

<p>The <a href="https://github.com/twitter/finagle/blob/master/finagle-core/src/main/scala/com/twitter/finagle/service/RetryFilter.scala">RetryFilter</a>, when hooked into the client stack, acts coordinating the retries of service executions. By default clients will retry any request that doesn&#39;t write anything to the output or throws any kind of <code>WriteException</code>. But the retry behavior can be easily customized and applied to pretty much any situation.</p>

<p>The conditions for whether a retry will happen or not, as well as the total number of retries and the time interval between them are defined on the <a href="https://github.com/twitter/finagle/blob/master/finagle-core/src/main/scala/com/twitter/finagle/service/RetryPolicy.scala">RetryPolicy</a> class.</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">retryCondition</span><span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Try</span><span class="o">[</span><span class="kt">Nothing</span><span class="o">]</span>, <span class="kt">Boolean</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Throw</span><span class="o">(</span><span class="n">error</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">error</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">TooManyRequestsException</span> <span class="o">=&gt;</span> <span class="kc">true</span>
    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="kc">false</span>
  <span class="o">}</span>
  <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="kc">false</span>
<span class="o">}</span>

<span class="k">val</span> <span class="n">retryPolicy</span> <span class="k">=</span> <span class="nc">RetryPolicy</span><span class="o">.</span><span class="n">tries</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">retryCondition</span><span class="o">)</span>

<span class="k">val</span> <span class="n">retryFilter</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">RetryExceptionsFilter</span><span class="o">[</span><span class="kt">Request</span>, <span class="kt">Response</span><span class="o">](</span>
   <span class="n">retryPolicy</span><span class="o">,</span> <span class="n">timer</span><span class="o">,</span> <span class="n">statsReceiver</span><span class="o">)</span>
</code></pre></div>
<p>The code above defines a retry filter, which will retry every request that fails with <code>TooManyrequestsException</code>, and will do it for at most 3 times, including the first attempt. The <code>.tries</code> factory method uses <a href="http://www.awsarchitectureblog.com/2015/03/backoff.html">jittered back-offs</a> between retries.</p>

<p>Finagle also allows you to specify your own back-off strategy, in case you need more control over the time interval between executions.</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">backoffs</span> <span class="k">=</span> <span class="nc">Stream</span><span class="o">(</span><span class="mf">1.</span><span class="n">second</span><span class="o">,</span> <span class="mf">4.</span><span class="n">seconds</span><span class="o">,</span> <span class="mf">8.</span><span class="n">seconds</span><span class="o">)</span>
<span class="k">val</span> <span class="n">retryPolicy</span> <span class="k">=</span> <span class="nc">RetryPolicy</span><span class="o">.</span><span class="n">backoff</span><span class="o">(</span><span class="n">backoffs</span><span class="o">)(</span><span class="n">retryCondition</span><span class="o">)</span>
</code></pre></div>
<h4>a note on service retries</h4>

<p>As I mentioned earlier, most common causes of service failures involves problems in the network or on the remote system, which won&#39;t be resolved right away. So be careful when defining back-off strategies and try not to use immediate retries, as they are likely to fail again for the exactly same reason.</p>

<p>On the other hand, using longer intervals might as well bring undesired results, specially from clients perspective. They will have to wait longer for service responses, risking pushing response time past timeout configuration.</p>

<p><a href="http://www.michaelnygard.com">Michael Nygard</a> has an excellent <a href="https://www.goodreads.com/book/show/1069827.Release_It_">book</a> on the subject where he recommends the queue-and-retry strategy for a slow retry, responding something to the user right away. The goal is to ensure that once the remote service is healthy again the overall system will be able to recover.</p>

<h3>Rate Limited Services</h3>

<p>Another important aspect to take into account is rate limiting. It has been widely adopted by most API vendors on the market, and is indeed a good practice to place them in front of services, specially those that will be exposed to the outside world. Rate limiting prevents brute force attacks and is also used to control access quotas for different client profiles.</p>

<p>Recently I was working integrating with a service that only allowed my client key to perform 10 requests within a second. So I wanted to find a way to make the Finagle client coordinate the calls to this API, and avoid as much as I could the propagation of any <code>HTTP 429 Too Many Requests</code> errors to end users.</p>

<p>Looking at Finagle codebase I came across the <a href="https://github.com/twitter/finagle/blob/master/finagle-core/src/main/scala/com/twitter/finagle/filter/RequestSemaphoreFilter.scala">RequestSemaphoreFilter</a> implementation which uses Twitter&#39;s <a href="https://github.com/twitter/util/blob/master/util-core/src/main/scala/com/twitter/concurrent/AsyncSemaphore.scala">AsyncSemaphore</a> to grant permits and enqueue waiters when no more permits are available. That was roughly what I was looking for, except for the fact that it doesn&#39;t take time into account.</p>

<p><a href="https://twitter.com/mnnakamura">Moses Nakamura</a> introduced me to the recently implemented <a href="https://github.com/twitter/util/blob/master/util-core/src/main/scala/com/twitter/concurrent/AsyncMeter.scala">AsyncMeter</a>, which has a similar behavior to the semaphore implementation, but adding time into the game. I could easily configure a new meter which releases 1 new permit every 100 milliseconds (10 per second), and allows at most 1000 waiters to be enqueued, as demonstrated on the snippet below.</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">meter</span> <span class="k">=</span> <span class="nc">AsyncMeter</span><span class="o">.</span><span class="n">newMeter</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mf">100.</span><span class="n">milliseconds</span><span class="o">,</span> <span class="mi">1000</span><span class="o">)</span>
</code></pre></div>
<p>There&#39;s also the handy <code>.perSecond</code> method, which simplifies this configuration and makes the code more readable.</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">meter</span> <span class="k">=</span> <span class="nc">AsyncMeter</span><span class="o">.</span><span class="n">perSecond</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">1000</span><span class="o">)</span>
</code></pre></div>
<p>From that I decided to make my first contribution to the project and implemented the <a href="https://github.com/twitter/finagle/blob/develop/finagle-core/src/main/scala/com/twitter/finagle/filter/RequestMeterFilter.scala">RequestMeterFilter</a> using the <code>AsyncMeter</code>. And as the docs states:</p>

<blockquote>
<p>A <code>Filter</code> that rate limits requests to a fixed rate over time by using the <code>AsyncMeter</code> implementation. It can be used for slowing down access to throttled resources. Requests that cannot be enqueued to await a permit are failed immediately with a <code>Failure</code> that signals that the work was never done, so it&#39;s safe to re-enqueue.</p>
</blockquote>

<p>Hooking the filter to the client definition is just a matter of instantiating it and adding to the stack, as follows.</p>
<div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">requestMeter</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">RequestMeterFilter</span><span class="o">(</span><span class="n">meter</span><span class="o">)</span>

<span class="k">val</span> <span class="n">limitedClient</span> <span class="k">=</span> <span class="n">requestMeter</span> <span class="n">andThen</span> <span class="n">client</span>
</code></pre></div>
<p>This filter will execute a new request every 100 milliseconds and will allow 1000 requests to enqueue, waiting for their time to execute. Once the waiting queue reaches the max size, new requests will be dropped immediately.</p>

<p>On the next post I will continue exploring Finagle client features in greater detail, more specifically Circuit Breakers (Failure Accrual and Fail Fast), Monitoring and client Statistics. But the material presented here is enough to start building fault tolerant clients. Have fun!</p>

        </section>
        <footer class="post-footer">
          <section class="share">
            
              
                <a class="icon-twitter" href="http://twitter.com/share?text=Building+Fault+Tolerant+Clients+With+Finagle+-+Part+1&amp;url=http://alexmartins.me/2015/12/30/building-fault-tolerant-clients-with-finagle-part-1"
                  onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
                <i class="fa fa-twitter"></i><span class="hidden">twitter</span>
                </a>
              
            
              
            
              
            
          </section>
        </footer>
        <div class="bottom-teaser cf">
          <h5 class="index-headline featured"><span>Written by</span></h5>
          <section class="author">
            <div class="author-image" style="background-image: url(/assets/images/author.jpg)">Blog Logo</div>
            <h4>Alexandre Martins</h4>
            <p class="bio">Tech Lead and Agile Coach. Currently helping build the technology vision and architecture of Globo's video streaming platform.</p>
            <p class="published">Published <time datetime="2015-12-30 00:00">30 Dec 2015</time></p>
          </section>
          
        </div>
        
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'alexmartins'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        
      </article>
    </main>
    <div class="bottom-closer">

    </div>
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/assets/js/index.js"></script>
<script type="text/javascript" src="/assets/js/readingTime.min.js"></script>
<script>
(function ($) {
  "use strict";
  $(document).ready(function(){

    var $window = $(window),
    $image = $('.post-image-image, .teaserimage-image');

      $window.on('scroll', function() {
        var top = $window.scrollTop();

        if (top < 0 || top > 1500) { return; }
        $image
          .css('transform', 'translate3d(0px, '+top/3+'px, 0px)')
          .css('opacity', 1-Math.max(top/700, 0));
      });
      $window.trigger('scroll');

      var height = $('.article-image').height();
      $('.post-content').css('padding-top', height + 'px');

      $('a[href*=#]:not([href=#])').click(function() {
        if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'')
         && location.hostname == this.hostname) {
          var target = $(this.hash);
          target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
          if (target.length) {
            $('html,body').animate({ scrollTop: target.offset().top }, 500);
            return false;
          }
        }
      });

  });
}(jQuery));
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-67119919-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>
