<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>RESTful Web Services: Preventing Race Conditions</title>
  <!-- <meta name="description" content="<p>One of the core premisses of RESTful web services is that HTTP should be seen as an application protocol rather than just a transport protocol. It comprises a whole bunch of semantics that allows us to build robust distributed systems. And for some cases, when multiple consumers manipulate the same resource, therefore changing its state, the solution should be robust enough to prevent the system to get into a race condition.</p>
" /> -->

  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@amartinsn" />
    <meta name="twitter:title" content="RESTful Web Services: Preventing Race Conditions" />
    <meta name="twitter:image" content="http://alexmartins.me/assets/images/author.jpg" />
    
    <meta name="twitter:description"  content="One of the core premisses of RESTful web services is that HTTP should be seen as an application protocol rather than just a transport protocol. It comprises a whole bunch of semantics that allows u..." />
    
  

  <meta property="og:site_name" content="Alexandre Martins" />
  <meta property="og:title" content="RESTful Web Services: Preventing Race Conditions"/>
  
  <meta property="og:description" content="One of the core premisses of RESTful web services is that HTTP should be seen as an application protocol rather than just a transport protocol. It comprises a whole bunch of semantics that allows u..." />
  
  <meta property="og:image" content="http://alexmartins.me/assets/images/author.jpg" />
  <meta property="og:url" content="http://alexmartins.me/restful-web-services-preventing-race-conditions" >
  <meta property="og:type" content="blog" />
  <meta property="article:published_time" content="2010-03-05T00:00:00-03:00">

  <link rel="canonical" href="http://alexmartins.me/restful-web-services-preventing-race-conditions">

  <link rel="shortcut icon" href="/assets/images/favicon.ico">
  <link rel="stylesheet" href="//brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
  <link rel="stylesheet" type="text/css" media="print" href="/css/print.css" />
</head>

  <body itemscope itemtype="http://schema.org/Article">
    <!-- header start -->

<!-- <a href="http://alexmartins.me" class="logo-readium"><span class="logo" style="background-image: url(/assets/images/author.jpg)"></span></a> -->

<!-- header end -->

    <main class="content" role="main">
      <article class="post">
        
        <div class="noarticleimage">
          <div class="post-meta">
            <h1 class="post-title">RESTful Web Services: Preventing Race Conditions</h1>
            <div class="cf post-meta-text">
              <div class="author-image" style="background-image: url(/assets/images/author.jpg)">Blog Logo</div>
              <a class="author-name" href="http://alexmartins.me" itemprop="author" itemscope itemtype="http://schema.org/Person">Alexandre Martins</a>
              on
              <time datetime="2010-03-05T00:00:00-03:00">05 Mar 2010</time>
              <!-- , tagged on <span class="post-tag-">, <a href="/tag/"></a></span> -->
            </div>
          </div>
        </div>
        <br>
        <br>
        
        <section class="post-content">
          <div class="post-reading">
            <span class="post-reading-time"></span> read
          </div>
          <a name="topofpage"></a>
          <p>One of the core premisses of RESTful web services is that HTTP should be seen as an application protocol rather than just a transport protocol. It comprises a whole bunch of semantics that allows us to build robust distributed systems. And for some cases, when multiple consumers manipulate the same resource, therefore changing its state, the solution should be robust enough to prevent the system to get into a race condition.</p>

<h3>But how HTTP could prevent that?</h3>

<p>HTTP provides a simple but powerful mechanism for aligning resource states by making use of <a href="http://en.wikipedia.org/wiki/HTTP_ETag">entity tag or ETag</a> and <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html">conditional request headers</a>. An <code>ETag</code> is anything that uniquely identifies an entity, such as the ID associated with a persisted resource, a checksum of the entity headers and body, etc. If this resource changes—that is, when one or more of its headers, or its entity body, changes—then the entity tag changes accordingly, reflecting this new resource state.</p>

<p>When a response contains an <code>ETag</code> associated to a resource state and you want to continue working with this same resource, it&#39;s recommended to use this tag in subsequent requests (called conditional requests), otherwise the resource state might eventually become out of sync with service one, returning something like a <code>409 Conflict</code>.</p>

<p>Conditional requests happens when the current <code>ETag</code> is supplied to a conditional request header, such as <code>If-Match</code> or <code>If-None-Match</code>, when user is requesting to update a resource for example. The service will then check the precondition, by comparing the current resource <code>ETag</code> with the one provided in the request. If it&#39;s satisfied than the server proceeds and process the request, otherwise it concludes that the resource has changed and responds with a <code>412 Precondition Failed</code>.</p>

<h4>Example</h4>

<p>Given an online shop for home goods, where two people— <strong>admin1</strong> and <strong>admin2</strong> —are responsible for administrating its contents. In our scenario both administrators are trying to change the state of the same product (the Weber BBQ), around the same time. <strong>admin1</strong> wants to lower the product price down to $300.00 and <strong>admin2</strong> wants to change its state to &quot;Not Available&quot;. Firstly, both administrators <code>GET</code> the current product state independently of one another by doing the following request:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">GET</span> <span class="o">/</span><span class="nx">product</span><span class="o">/</span><span class="mi">1</span> <span class="nx">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="nx">Host</span><span class="o">:</span> <span class="nx">myshop</span><span class="p">.</span><span class="nx">com</span>
</code></pre></div>
<p>Returning the following resource (product) as response. Note that the service&#39;s response contains an <code>ETag</code> header.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nx">OK</span>
<span class="nx">Content</span><span class="o">-</span><span class="nx">Length</span><span class="o">:</span> <span class="mi">265</span>
<span class="nx">Content</span><span class="o">-</span><span class="nx">Type</span><span class="o">:</span> <span class="nx">application</span><span class="o">/</span><span class="nx">json</span>
<span class="nx">ETag</span><span class="o">:</span> <span class="s2">&quot;686897696a7c876b7e&quot;</span>

<span class="p">{</span>
  <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;WeberFamilyBBQ&quot;</span><span class="p">,</span>
  <span class="s2">&quot;description&quot;</span><span class="o">:</span> <span class="s2">&quot;Great for parties and cooks a neat roast too.&quot;</span><span class="p">,</span>
  <span class="s2">&quot;price&quot;</span><span class="o">:</span> <span class="mi">399</span><span class="p">,</span>
  <span class="s2">&quot;status&quot;</span><span class="o">:</span> <span class="s2">&quot;InStock&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>When <strong>admin1</strong> does a conditional PUT, including an <code>If-Match</code> header with the <code>ETag</code> value from the previous <code>GET</code>.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">PUT</span> <span class="o">/</span><span class="nx">product</span><span class="o">/</span><span class="mi">1</span> <span class="nx">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="nx">Host</span><span class="o">:</span> <span class="nx">myshop</span><span class="p">.</span><span class="nx">com</span>
<span class="nx">If</span><span class="o">-</span><span class="nx">Match</span><span class="o">:</span> <span class="s2">&quot;686897696a7c876b7e&quot;</span>

<span class="p">{</span>
  <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;WeberFamilyBBQ&quot;</span><span class="p">,</span>
  <span class="s2">&quot;description&quot;</span><span class="o">:</span> <span class="s2">&quot;Great for parties and cooks a neat roast too.&quot;</span><span class="p">,</span>
  <span class="s2">&quot;price&quot;</span><span class="o">:</span> <span class="mi">399</span><span class="p">,</span>
  <span class="s2">&quot;status&quot;</span><span class="o">:</span> <span class="s2">&quot;InStock&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>And as the product state hasn&#39;t changed since the last request, then the request is thus successful! Notice that the response returns an updated <code>ETag</code> value, reflecting the new product state.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">204</span> <span class="nx">No</span> <span class="nx">Content</span>
<span class="nx">ETag</span><span class="o">:</span> <span class="s2">&quot;616898r96a8cy86b8eee11&quot;</span>
</code></pre></div>
<p>Little time after <strong>admin1</strong> has updated the product, <strong>admin2</strong> does another <code>PUT</code> request to the same product, including the same <code>If-Match</code> header with the <code>ETag</code> value from the <code>GET</code> request.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">PUT</span> <span class="o">/</span><span class="nx">product</span><span class="o">/</span><span class="mi">1</span> <span class="nx">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="nx">Host</span><span class="o">:</span> <span class="nx">myshop</span><span class="p">.</span><span class="nx">com</span>
<span class="nx">If</span><span class="o">-</span><span class="nx">Match</span><span class="o">:</span> <span class="s2">&quot;686897696a7c876b7e&quot;</span>

<span class="p">{</span>
  <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;WeberFamilyBBQ&quot;</span><span class="p">,</span>
  <span class="s2">&quot;description&quot;</span><span class="o">:</span> <span class="s2">&quot;Great for parties and cooks a neat roast too.&quot;</span><span class="p">,</span>
  <span class="s2">&quot;price&quot;</span><span class="o">:</span> <span class="mi">399</span><span class="p">,</span>
  <span class="s2">&quot;status&quot;</span><span class="o">:</span> <span class="s2">&quot;InStock&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>The service then determines that someone is trying to change the same product, using an out-of-date resource representation (<code>ETags</code> are different!), and responds with a <code>412 Precondition Failed</code> code. No race conditions whatsoever!</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">412</span> <span class="nx">Precondition</span> <span class="nx">Failed</span>
</code></pre></div>
<h3>Conclusion</h3>

<p>Although ETags and conditional request headers make up a powerful mechanism for dealing with concurrency, one thing to keep in mind is that, depending on the amount of computation performed by the server to generate an <code>ETag</code>, response times might increase considerably. So use it only if you need it!</p>

<p>Special thanks to <a href="http://jim.webber.name">Jim Webber</a> for helping me with this post. For more information on RESTful Web Services, check out his latest book (written together with <a href="http://savas.me">Savas Parastatidis</a> and <a href="http://iansrobinson.com">Ian Robinson</a>)— <a href="http://www.amazon.com/gp/product/0596805829">REST in Practice: Hypermedia and Systems Architecture</a>.</p>

        </section>
        <footer class="post-footer">
          <section class="share">
            
              
                <a class="icon-twitter" href="http://twitter.com/share?text=RESTful+Web+Services%3A+Preventing+Race+Conditions&amp;url=http://alexmartins.me/restful-web-services-preventing-race-conditions"
                  onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
                <i class="fa fa-twitter"></i><span class="hidden">twitter</span>
                </a>
              
            
              
            
              
            
          </section>
        </footer>
        <div class="bottom-teaser cf">
          <h5 class="index-headline featured"><span>Written by</span></h5>
          <section class="author">
            <div class="author-image" style="background-image: url(/assets/images/author.jpg)">Blog Logo</div>
            <h4>Alexandre Martins</h4>
            <p class="bio">Tech Lead and Agile Coach. Currently helping build the technology vision and architecture of Globo's video streaming platform.</p>
            <p class="published">Published <time datetime="2010-03-05 00:00">05 Mar 2010</time></p>
          </section>
          
        </div>
        
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'alexmartins'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        
      </article>
    </main>
    <div class="bottom-closer">

    </div>
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/assets/js/index.js"></script>
<script type="text/javascript" src="/assets/js/readingTime.min.js"></script>
<script>
(function ($) {
  "use strict";
  $(document).ready(function(){

    var $window = $(window),
    $image = $('.post-image-image, .teaserimage-image');

      $window.on('scroll', function() {
        var top = $window.scrollTop();

        if (top < 0 || top > 1500) { return; }
        $image
          .css('transform', 'translate3d(0px, '+top/3+'px, 0px)')
          .css('opacity', 1-Math.max(top/700, 0));
      });
      $window.trigger('scroll');

      var height = $('.article-image').height();
      $('.post-content').css('padding-top', height + 'px');

      $('a[href*=#]:not([href=#])').click(function() {
        if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'')
         && location.hostname == this.hostname) {
          var target = $(this.hash);
          target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
          if (target.length) {
            $('html,body').animate({ scrollTop: target.offset().top }, 500);
            return false;
          }
        }
      });

  });
}(jQuery));
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-67119919-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>
